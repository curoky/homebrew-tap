name: test on osx
on:
  push:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  install:
    strategy:
      fail-fast: false
      max-parallel: 100
      matrix:
        os: [macos-latest]
        package:
          # ls Formula | xargs -n 1 | sed -e 's/.rb/ /' -e 's/^/          - /'
          # - bazel@3           # Note: linux only
          # - bazel-buildtools  # Note: linux only
          - bazel-compilation-database
          # - cmake-format      # Note: not completed
          - cpplint
          - git-mv-with-history
          # - glibc2.32         # Note: linux only
          - hexo
          - include-what-you-use@15
          - libevent-openssl1.0
          - llvm-latest
          # - miniconda         # Note: linux only, osx has cask one
          # - ncurses@5         # Note: linux only
          # - ncurses-termlib   # Note: linux only
          - openssl@1.0.2t
          # - openssl@1.0.2u    # Note: linux only
          # - oracle-jdk        # Note: linux only, osx has cask one
          # - python@2_linux    # Note: linux only
          - spaceship-prompt
          # - thrift@0.9.3      # Note: Error: libcrypto required.
          - typora-bundle
          - vim-bundle
          - wangle@2021.02.15
          - zsh-bundle

    runs-on: ${{ matrix.os }}

    env:
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_AUTO_UPDATE: 1

    steps:
      - uses: actions/checkout@v2

      - name: homebrew cache
        uses: actions/cache@v2
        with:
          path: ~/.cache/Homebrew
          key: ${{ matrix.package }}-${{ hashFiles(format('Formula/{0}.rb', matrix.package)) }}
          restore-keys: |
            ${{ matrix.package }}-

      - name: link cache path
        run: |
          mkdir -p ~/.cache/Homebrew || echo "ignore exits"
          rm -rf $(brew --cache)
          ln -s ~/.cache/Homebrew $(brew --cache)
          ls -la $(brew --cache)

      - name: upgrade homebrew
        run: brew update && brew upgrade || echo "ignore failed"

      - name: unlink preinstall nodejs
        run: echo node@12 python@3.8 | xargs -n 1 brew unlink || echo "ignore Failed"

      - name: remove openssl@1.0.2t in local tap
        run: rm -rf $(brew --repo)/Library/Taps/local

      - uses: curoky/actions/brew-tap-install-test@master
        with:
          formula: ${{ matrix.package }}

  install_cask:
    runs-on: macos-latest
    env:
      HOMEBREW_NO_ANALYTICS: 1
      HOMEBREW_NO_AUTO_UPDATE: 1

    steps:
      - uses: actions/checkout@v2

      - name: link tap
        run: |
          mkdir -p $(brew --repo)/Library/Taps/curoky
          cp -r $PWD $(brew --repo)/Library/Taps/curoky/homebrew-custom

      - name: install cask
        run: brew cask install freefilesync
